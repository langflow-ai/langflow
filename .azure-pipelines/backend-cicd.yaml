# AI Studio Backend CI/CD Pipeline
# Follows Genesis template pattern

variables:
  major: 1
  minor: 0
  patch: $[counter(variables['Build.SourceBranchName'], 0)]
  globalPatch: $[counter('globalPatch', 0)]

  # Container Registry Configuration
  ACR_RESOURCE_GROUP: sprintRG
  AZURE_CONTAINER_REGISTRY: sprintregistry
  ACR_ENDPOINT: 'sprintregistry.azurecr.io'

  # Backend Configuration
  IMAGE_NAME: 'ai-studio-backend'
  DOCKERFILE_PATH: 'docker/backend/Dockerfile'
  PYTHON_VERSION: '3.12'
  UV_VERSION: '0.4.0'

  # Platform Charts Configuration
  VALUES_FILE: 'charts/genesis-platform/values-dev.yaml'

resources:
  repositories:
  - repository: platform-charts
    type: github
    endpoint: autonomize-ai
    name: autonomize-ai/platform-charts
    ref: main

trigger:
  branches:
    include:
    - main
    - develop
    - feature/*
  paths:
    include:
      - src/backend/**
      - docker/backend/**
      - pyproject.toml
      - uv.lock
      - .azure-pipelines/backend-cicd.yaml
      - .azure-pipelines/templates/*backend*
      - .azure-pipelines/templates/release-template.yml

pr:
  branches:
    include:
    - main
    - develop
  paths:
    include:
      - src/backend/**
      - docker/backend/**
      - pyproject.toml
      - uv.lock
      - .azure-pipelines/backend-cicd.yaml
      - .azure-pipelines/templates/*backend*

stages:
- stage: Build
  displayName: 'Build Backend Image'
  condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
  jobs:
  - template: templates/backend-build-template.yml
    parameters:
      CONTAINER_NAME: $(IMAGE_NAME)
      DOCKERFILE_PATH: $(DOCKERFILE_PATH)
      AZURE_CONTAINER_REGISTRY: $(AZURE_CONTAINER_REGISTRY)
      BUILD_ARGS: |
        --build-arg BUILD_VERSION=$(Build.BuildNumber)
        --build-arg PYTHON_VERSION=$(PYTHON_VERSION)

- stage: UpdatePlatformCharts
  displayName: 'Update Platform Charts'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - template: templates/release-template.yml
    parameters:
      SERVICE_NAME: 'backend'
      IMAGE_NAME: $(IMAGE_NAME)

