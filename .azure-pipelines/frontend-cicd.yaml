# AI Studio Frontend CI/CD Pipeline
# Follows Genesis template pattern

variables:
  major: 1
  minor: 0
  patch: $[counter(variables['Build.SourceBranchName'], 0)]
  globalPatch: $[counter('globalPatch', 0)]

  # Container Registry Configuration
  ACR_RESOURCE_GROUP: sprintRG
  AZURE_CONTAINER_REGISTRY: sprintregistry
  ACR_ENDPOINT: 'sprintregistry.azurecr.io'

  # Frontend Configuration
  IMAGE_NAME: 'ai-studio-frontend'
  DOCKERFILE_PATH: 'docker/frontend/Dockerfile'
  NODE_VERSION: '20.x'

  # Platform Charts Configuration
  VALUES_FILE: 'genesis-umbrella/values-dev.yaml'

resources:
  repositories:
  - repository: ai-studio-charts
    type: github
    endpoint: autonomize-ai
    name: autonomize-ai/ai-studio-charts
    ref: main

trigger:
  branches:
    include:
    - main
    - develop
    - feature/*
  paths:
    include:
      - src/frontend/**
      - docker/frontend/**
      - .azure-pipelines/frontend-cicd.yaml
      - .azure-pipelines/templates/*frontend*
      - .azure-pipelines/templates/release-template.yml

pr:
  branches:
    include:
    - main
    - develop
  paths:
    include:
      - src/frontend/**
      - docker/frontend/**
      - .azure-pipelines/frontend-cicd.yaml
      - .azure-pipelines/templates/*frontend*

stages:
- stage: Build
  displayName: 'Build Frontend Image'
  condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
  jobs:
  - template: templates/frontend-build-template.yml
    parameters:
      CONTAINER_NAME: $(IMAGE_NAME)
      DOCKERFILE_PATH: $(DOCKERFILE_PATH)
      AZURE_CONTAINER_REGISTRY: $(AZURE_CONTAINER_REGISTRY)
      BUILD_ARGS: |
        --build-arg BUILD_VERSION=$(Build.BuildNumber)
        --build-arg NODE_ENV=production

- stage: UpdatePlatformCharts
  displayName: 'Update Platform Charts'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - template: templates/release-template.yml
    parameters:
      SERVICE_NAME: 'frontend'
      IMAGE_NAME: $(IMAGE_NAME)

