parameters:
  - name: CONTAINER_NAME
    type: string
  - name: DOCKERFILE_PATH
    type: string
  - name: AZURE_CONTAINER_REGISTRY
    type: string
  - name: BUILD_ARGS
    type: string
    default: ''

jobs:
- job: BuildAndPushBackend
  displayName: 'Build and Push Backend'
  pool:
    name: ad-vmss-p1
  steps:
  - checkout: self
    submodules: true
    persistCredentials: true

  - script: |
      sudo apt-get update
      sudo apt-get install -y apt-transport-https ca-certificates curl software-properties-common
      curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
      sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
      sudo apt-get update
      sudo apt-get install -y docker-ce containerd.io
      sudo systemctl start docker
      sudo chmod 666 /var/run/docker.sock || true
      docker version
    displayName: Install Docker Engine

  - task: Docker@2
    displayName: 'Build Backend Image'
    inputs:
      command: 'build'
      repository: '${{ parameters.CONTAINER_NAME }}'
      containerRegistry: '${{ parameters.AZURE_CONTAINER_REGISTRY }}'
      dockerfile: '${{ parameters.DOCKERFILE_PATH }}'
      buildContext: '.'
      ${{ if ne(parameters.BUILD_ARGS, '') }}:
        arguments: '${{ parameters.BUILD_ARGS }}'
      tags: |
        $(Build.BuildNumber)
        latest
    condition: and(succeeded(), in(variables['Build.Reason'], 'Manual', 'IndividualCI', 'BatchedCI'))

  - script: docker images
    displayName: 'List Docker Images'

  - task: Docker@2
    displayName: 'Push Backend Image'
    inputs:
      command: 'push'
      repository: '${{ parameters.CONTAINER_NAME }}'
      containerRegistry: '${{ parameters.AZURE_CONTAINER_REGISTRY }}'
      tags: |
        $(Build.BuildNumber)
        latest
    condition: and(succeeded(), in(variables['Build.Reason'], 'Manual', 'IndividualCI', 'BatchedCI'))

  - script: |
      echo "‚úÖ Backend image built and pushed successfully"
      echo "üê≥ Image: ${{ parameters.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ parameters.CONTAINER_NAME }}:$(Build.BuildNumber)"
      echo "üì¶ Backend Components:"
      echo "  - Genesis Spec System"
      echo "  - Langflow Components"
      echo "  - AI Studio APIs"
      echo "  - Healthcare Components"
    displayName: 'Backend Build Summary'
