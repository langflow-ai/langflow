server {
    listen 80;
    server_name localhost;

    # Enable CORS for all requests
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,x-user-token' always;
    add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;

    # Handle preflight requests
    location / {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,x-user-token';
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' 0;
            return 204;
        }

        # Mock API endpoints
        try_files $uri $uri/ @mock_api;
    }

    # Mock API handler
    location @mock_api {
        default_type application/json;

        # Health check
        if ($uri ~ ^/health) {
            return 200 '{"status": "healthy", "timestamp": "$time_iso8601"}';
        }

        # Auto login endpoint (traditional auth)
        if ($uri ~ ^/api/v1/auto_login) {
            return 200 '{"access_token": "mock-traditional-token", "refresh_token": "mock-refresh-token", "auto_login": true}';
        }

        # User data endpoint (both traditional and genesis-studio API)
        if ($uri ~ ^/api/v1/users/whoami) {
            return 200 '{"id": "test-user", "username": "testuser", "email": "test@example.com", "is_superuser": false}';
        }
        if ($uri ~ ^/api/v1/genesis-studio/users/whoami) {
            return 200 '{"id": "test-user", "username": "testuser", "email": "test@example.com", "is_superuser": false}';
        }

        # Version endpoint (both traditional and genesis-studio API)
        if ($uri ~ ^/api/v1/version) {
            return 200 '{"version": "1.0.0-test", "build": "mock-build"}';
        }
        if ($uri ~ ^/api/v1/genesis-studio/version) {
            return 200 '{"version": "1.0.0-test", "build": "mock-build"}';
        }

        # Config endpoint (both traditional and genesis-studio API)
        if ($uri ~ ^/api/v1/config) {
            return 200 '{"frontend_timeout": 60000, "max_file_size": 100, "features": ["chat", "agent_builder"]}';
        }
        if ($uri ~ ^/api/v1/genesis-studio/config) {
            return 200 '{"frontend_timeout": 60000, "max_file_size": 100, "features": ["chat", "agent_builder"]}';
        }

        # Global variables endpoint (both traditional and genesis-studio API)
        if ($uri ~ ^/api/v1/variables) {
            return 200 '[]';
        }
        if ($uri ~ ^/api/v1/genesis-studio/variables) {
            return 200 '[]';
        }

        # Tags endpoint (both traditional and genesis-studio API)
        if ($uri ~ ^/api/v1/store/tags) {
            return 200 '[]';
        }
        if ($uri ~ ^/api/v1/genesis-studio/store/tags) {
            return 200 '[]';
        }

        # Folders endpoint (both traditional and genesis-studio API)
        if ($uri ~ ^/api/v1/folders) {
            return 200 '[]';
        }
        if ($uri ~ ^/api/v1/genesis-studio/folders) {
            return 200 '[]';
        }

        # Basic examples endpoint (both traditional and genesis-studio API)
        if ($uri ~ ^/api/v1/flows/examples) {
            return 200 '[]';
        }
        if ($uri ~ ^/api/v1/genesis-studio/flows/examples) {
            return 200 '[]';
        }

        # Token refresh endpoint (traditional auth)
        if ($uri ~ ^/api/v1/refresh) {
            return 200 '{"access_token": "mock-refreshed-token", "refresh_token": "mock-new-refresh-token"}';
        }
        if ($uri ~ ^/api/v1/genesis-studio/refresh) {
            return 200 '{"access_token": "mock-refreshed-token", "refresh_token": "mock-new-refresh-token"}';
        }

        # Logout endpoint (both traditional and genesis-studio API)
        if ($uri ~ ^/api/v1/logout) {
            return 200 '{"message": "Logged out successfully"}';
        }
        if ($uri ~ ^/api/v1/genesis-studio/logout) {
            return 200 '{"message": "Logged out successfully"}';
        }

        # Default response for unmatched endpoints
        return 404 '{"error": "Mock endpoint not found", "path": "$uri", "method": "$request_method"}';
    }

    # Serve static files
    location /test-config.json {
        root /usr/share/nginx/html;
    }

    # Log requests for debugging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log debug;
}