name: Add Community Label

on:
  pull_request_target:
    types: [opened]

jobs:
  add-label:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Add community label
        uses: actions/github-script@v7
        with:
          script: |
            const author = context.payload.pull_request.user.login;
            const org = context.repo.owner;

            // Check if user is a member of the organization
            // null = unable to determine, true = member, false = confirmed non-member
            let isOrgMember = null;
            try {
              await github.rest.orgs.checkMembershipForUser({
                org: org,
                username: author
              });
              isOrgMember = true;
            } catch (error) {
              const status = error.status || error.response?.status;
              if (status === 404) {
                // 404 means user is confirmed not a member
                isOrgMember = false;
              } else {
                // For other errors (network, 403, 429, 5xx), we cannot determine membership
                // Log the error and skip labeling to avoid false positives
                console.log(`Unable to determine org membership for ${author}: ${error.message} (status: ${status})`);
                isOrgMember = null;
              }
            }

            // Only add community label if we confirmed the user is NOT an org member
            if (isOrgMember === false) {
              const pullRequestNumber = context.payload.pull_request.number;
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pullRequestNumber,
                labels: ['community']
              });
            }
