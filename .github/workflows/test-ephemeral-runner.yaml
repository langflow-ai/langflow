# Ephemeral Runner Validation Workflow
# ..
# This workflow validates that the ephemeral runner is truly ephemeral by:
# 1. Creating test artifacts (files and Docker images) in one run
# 2. Verifying in subsequent runs that these artifacts are gone
#
# GCP Behavior Explanation:
# When the runner service stops, /usr/local/bin/runner-exit-shutdown.sh triggers
# a VM shutdown via kernel sysrq. GCP infrastructure (likely using Instance Templates
# or Managed Instance Groups) detects the terminated instance and automatically
# recreates it with the same instance name. This means:
# - The VM instance NAME stays the same (recreated with same name)
# - But it's a BRAND NEW VM with a fresh boot disk (ephemeral)
# - All files, Docker images, and state from the previous run are completely gone
# - Each job runs on a completely fresh VM instance
#
# The "replace" behavior you observe is GCP's auto-healing/recreation mechanism,
# not a persistent VM being reused.

name: ðŸ§ª test invoke ephemeral runner (Step 1) 
on:
  push: 
    branches: [test-ephemeral-runner]

jobs:
  show-runner-info:
    runs-on: 
      labels: ["self-hosted", "linux", "ARM64", "langflow-ai-arm64-40gb-ephemeral"]
    permissions:
      actions: read
      contents: read
    steps:
      - name: Show Runner Info in Summary
        run: |
          {
            echo "## ðŸ–¥ï¸ Self-Hosted Runner Info: "
            echo "---------- "
            echo "GITHUB_RUNNER_NAME   : '${{ runner.name }}'"
            echo "GITHUB_RUNNER_OS     : '${{ runner.os }}'"
            echo "ENV RUNNER_NAME      : '$RUNNER_NAME'"            
            echo "----------"
            echo "**Hostname:** $(hostname)"
            echo "**Machine:** $(uname -a)"
            echo "**GitHub Workspace:** $GITHUB_WORKSPACE"
            echo "**Runner Temp Dir:** $RUNNER_TEMP"
            echo "**Runner Tool Cache:** $RUNNER_TOOL_CACHE"
            echo ""
            echo "### Environment Variables"
            echo '```'
            printenv | sort
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Verify Previous Run Artifacts Are Gone (Ephemeral Check)         
        run: |
          {
            echo "## ðŸ” Ephemeral Validation: Checking for Previous Run Artifacts"
            echo ""
            echo "### Step 1: Verifying Clean State (Before Creating New Artifacts)"
            echo ""
            
            # Diagnostic information to understand VM state
            echo "### VM Diagnostic Information" >> "$GITHUB_STEP_SUMMARY"
            echo "**Hostname:** $(hostname)" >> "$GITHUB_STEP_SUMMARY"
            echo "**System Uptime:** $(uptime -p 2>/dev/null || uptime)" >> "$GITHUB_STEP_SUMMARY"
            echo "**Boot Time:** $(who -b 2>/dev/null | awk '{print $3, $4}' || date -d @$(awk '/btime/ {print $2}' /proc/stat))" >> "$GITHUB_STEP_SUMMARY"
            echo "**Current Time:** $(date)" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY" 
            
            # Check for test files from PREVIOUS runs
            echo "Checking for test files from previous runs..."
            PREVIOUS_TEST_FILES=$(find /opt/actions-runner /tmp -name "ephemeral-test-artifact-*.txt" 2>/dev/null | head -20 || true)
            
            if [ -n "$PREVIOUS_TEST_FILES" ]; then
              echo "âŒ **FAILED:** Found test files from previous run(s):"
              echo "$PREVIOUS_TEST_FILES"
              echo ""
              echo "**Files from previous runs:**" >> "$GITHUB_STEP_SUMMARY"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
              echo "$PREVIOUS_TEST_FILES" >> "$GITHUB_STEP_SUMMARY"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
              
              # Show file details for debugging
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "**File details:**" >> "$GITHUB_STEP_SUMMARY"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
              while IFS= read -r file; do
                if [ -n "$file" ] && [ -f "$file" ]; then
                  echo "File: $file" >> "$GITHUB_STEP_SUMMARY"
                  echo "Modified: $(stat -c '%y' "$file" 2>/dev/null || ls -l "$file")" >> "$GITHUB_STEP_SUMMARY"
                  echo "Contents:" >> "$GITHUB_STEP_SUMMARY"
                  cat "$file" >> "$GITHUB_STEP_SUMMARY" 2>/dev/null || echo "(cannot read)" >> "$GITHUB_STEP_SUMMARY"
                  echo "---" >> "$GITHUB_STEP_SUMMARY"
                fi
              done <<< "$PREVIOUS_TEST_FILES"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
              
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "âŒ **Ephemeral validation FAILED** - Files persist across runs!" >> "$GITHUB_STEP_SUMMARY"
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "**Possible causes:**" >> "$GITHUB_STEP_SUMMARY"
              echo "1. VM is not being shut down/recreated (check shutdown script)" >> "$GITHUB_STEP_SUMMARY"
              echo "2. GCP is using persistent boot disk or snapshots" >> "$GITHUB_STEP_SUMMARY"
              echo "3. VM instance template includes these files" >> "$GITHUB_STEP_SUMMARY"
              echo "4. Boot disk is being preserved between VM recreations" >> "$GITHUB_STEP_SUMMARY"
              exit 1
            else
              echo "âœ… No test files found from previous runs"
              echo "âœ… **File ephemeral check PASSED**" >> "$GITHUB_STEP_SUMMARY"
            fi
            
            # Check for Docker images from PREVIOUS runs
            echo ""
            echo "Checking for test Docker images from previous runs..."
            PREVIOUS_TEST_IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "ephemeral-test-image" || true)
            
            if [ -n "$PREVIOUS_TEST_IMAGES" ]; then
              echo "âŒ **FAILED:** Found Docker images from previous run(s):"
              echo "$PREVIOUS_TEST_IMAGES"
              echo ""
              echo "**Images from previous runs:**" >> "$GITHUB_STEP_SUMMARY"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
              while IFS= read -r image; do
                if [ -n "$image" ]; then
                  docker images "$image" >> "$GITHUB_STEP_SUMMARY" 2>/dev/null || echo "$image (not found)" >> "$GITHUB_STEP_SUMMARY"
                fi
              done <<< "$PREVIOUS_TEST_IMAGES"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
              echo "âŒ **Ephemeral validation FAILED** - Docker images persist across runs!" >> "$GITHUB_STEP_SUMMARY"
              exit 1
            else
              echo "âœ… No test Docker images found from previous runs"
              echo "âœ… **Docker image ephemeral check PASSED**" >> "$GITHUB_STEP_SUMMARY"
            fi
            
            echo ""
            echo "### âœ… Ephemeral Validation Summary"
            echo ""
            echo "âœ… **All ephemeral checks PASSED**" >> "$GITHUB_STEP_SUMMARY"
            echo "âœ… Files from previous runs: **GONE**" >> "$GITHUB_STEP_SUMMARY"
            echo "âœ… Docker images from previous runs: **GONE**" >> "$GITHUB_STEP_SUMMARY"
            echo ""
            echo "**Conclusion:** Runner is truly ephemeral - each job runs on a fresh VM instance." >> "$GITHUB_STEP_SUMMARY"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Verify Workspace Clean from Previous Run
        run: |
          {
            echo "## ðŸ” Workspace Cleanup Validation"
            echo ""
            echo "### Checking if workspace directory persists from previous runs"
            echo ""
            
            WORKSPACE_DIR="${{ github.workspace }}"
            WORKSPACE_PARENT=$(dirname "$WORKSPACE_DIR")
            
            echo "**Workspace directory:** \`$WORKSPACE_DIR\`" >> "$GITHUB_STEP_SUMMARY"
            echo "**Workspace parent:** \`$WORKSPACE_PARENT\`" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            
            # Check if there are any directories in the workspace parent that look like previous checkouts
            # GitHub Actions typically creates directories like: _work/repo-name/repo-name
            echo "Checking for leftover workspace directories from previous runs..."
            
            # Check the _work directory structure
            if [ -d "$WORKSPACE_PARENT" ]; then
              echo "**Contents of workspace parent:**" >> "$GITHUB_STEP_SUMMARY"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
              ls -la "$WORKSPACE_PARENT" >> "$GITHUB_STEP_SUMMARY" 2>&1 || echo "Cannot list directory" >> "$GITHUB_STEP_SUMMARY"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
              echo "" >> "$GITHUB_STEP_SUMMARY"
              
              # Count directories (excluding current workspace)
              OTHER_DIRS=$(find "$WORKSPACE_PARENT" -maxdepth 1 -type d ! -path "$WORKSPACE_DIR" ! -path "$WORKSPACE_PARENT" 2>/dev/null | wc -l || echo "0")
              
              if [ "$OTHER_DIRS" -gt 0 ]; then
                echo "âš ï¸ Found $OTHER_DIRS other directory(ies) in workspace parent" >> "$GITHUB_STEP_SUMMARY"
                echo "**Other directories:**" >> "$GITHUB_STEP_SUMMARY"
                echo '```' >> "$GITHUB_STEP_SUMMARY"
                find "$WORKSPACE_PARENT" -maxdepth 1 -type d ! -path "$WORKSPACE_DIR" ! -path "$WORKSPACE_PARENT" >> "$GITHUB_STEP_SUMMARY" 2>&1
                echo '```' >> "$GITHUB_STEP_SUMMARY"
              else
                echo "âœ… No other directories found in workspace parent" >> "$GITHUB_STEP_SUMMARY"
              fi
            fi
            
            # Check if current workspace has unexpected files (indicating it wasn't cleaned)
            # After checkout, we should only have repo files, not test artifacts
            echo ""
            echo "Checking current workspace for unexpected files from previous runs..."
            
            # Look for test artifact files in the workspace
            TEST_FILES_IN_WORKSPACE=$(find "$WORKSPACE_DIR" -name "ephemeral-test-*" -o -name "*ephemeral*" 2>/dev/null | grep -v ".git" || true)
            
            if [ -n "$TEST_FILES_IN_WORKSPACE" ]; then
              echo "âŒ **FAILED:** Found test files in workspace from previous run(s):"
              echo "$TEST_FILES_IN_WORKSPACE"
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "âŒ **Workspace cleanup validation FAILED**" >> "$GITHUB_STEP_SUMMARY"
              echo "**Test files found in workspace:**" >> "$GITHUB_STEP_SUMMARY"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
              echo "$TEST_FILES_IN_WORKSPACE" >> "$GITHUB_STEP_SUMMARY"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
              exit 1
            else
              echo "âœ… No test files found in workspace"
              echo "âœ… **Workspace cleanup check PASSED**" >> "$GITHUB_STEP_SUMMARY"
            fi
            
            # Check workspace directory modification time vs current time
            # If workspace was created/modified long ago, it might be from a previous run
            if [ -d "$WORKSPACE_DIR" ]; then
              WORKSPACE_MTIME=$(stat -c '%Y' "$WORKSPACE_DIR" 2>/dev/null || stat -f '%m' "$WORKSPACE_DIR" 2>/dev/null || echo "0")
              CURRENT_TIME=$(date +%s)
              TIME_DIFF=$((CURRENT_TIME - WORKSPACE_MTIME))
              
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "**Workspace directory age:** $TIME_DIFF seconds old" >> "$GITHUB_STEP_SUMMARY"
              
              # If workspace is more than 5 minutes old and we just checked out, something is wrong
              if [ "$TIME_DIFF" -gt 300 ]; then
                echo "âš ï¸ Workspace directory is $TIME_DIFF seconds old (may indicate persistence)" >> "$GITHUB_STEP_SUMMARY"
              else
                echo "âœ… Workspace directory appears fresh" >> "$GITHUB_STEP_SUMMARY"
              fi
            fi
            
            echo ""
            echo "### âœ… Workspace Validation Summary" >> "$GITHUB_STEP_SUMMARY"
            echo "âœ… Workspace appears clean from previous runs" >> "$GITHUB_STEP_SUMMARY"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create Test Artifacts (File and Docker Image) 
        id: create-artifacts
        run: |
          {
            echo "## ðŸ§ª Ephemeral Runner Validation Test"
            echo ""
            echo "### Step 2: Creating Test Artifacts (For Next Run Validation)"
            echo ""
            
            # Create a test file in a persistent location (outside workspace)
            # Use /tmp which is writable by the runner user, or /opt/actions-runner if available
            if [ -w /opt/actions-runner ]; then
              TEST_FILE="/opt/actions-runner/ephemeral-test-artifact-$(date +%s).txt"
            else
              TEST_FILE="/tmp/ephemeral-test-artifact-$(date +%s).txt"
            fi
            echo "Creating test file: $TEST_FILE"
            echo "Created at: $(date -Iseconds)" > "$TEST_FILE"
            echo "Runner name: ${{ runner.name }}" >> "$TEST_FILE"
            echo "Hostname: $(hostname)" >> "$TEST_FILE"
            echo "âœ… Test file created: $TEST_FILE"
            echo "**Test file:** \`$TEST_FILE\`" >> "$GITHUB_STEP_SUMMARY"
            
            # Verify file exists
            if [ -f "$TEST_FILE" ]; then
              echo "âœ… File exists: $(ls -lh "$TEST_FILE")"
              echo "**File contents:**" >> "$GITHUB_STEP_SUMMARY"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
              cat "$TEST_FILE" >> "$GITHUB_STEP_SUMMARY"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
            else
              echo "âŒ File creation failed!"
              exit 1
            fi
            
            # Build a test Docker image
            TEST_IMAGE="ephemeral-test-image:$(date +%s)"
            echo ""
            echo "Building Docker image: $TEST_IMAGE"
            # Create Dockerfile content using printf to avoid YAML heredoc issues
            printf 'FROM alpine:latest\nLABEL test.ephemeral="true"\nLABEL test.runner="%s"\nRUN echo "Test image for ephemeral validation" > /test.txt\n' "${{ runner.name }}" > /tmp/Dockerfile.ephemeral-test
            docker build -t "$TEST_IMAGE" -f /tmp/Dockerfile.ephemeral-test .
            
            if [ $? -eq 0 ]; then
              echo "âœ… Docker image built: $TEST_IMAGE"
              echo "**Docker image:** \`$TEST_IMAGE\`" >> "$GITHUB_STEP_SUMMARY"
              
              # List the image
              echo ""
              echo "Docker images matching 'ephemeral-test-image':"
              docker images | grep ephemeral-test-image || echo "No matching images found"
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "**Docker images:**" >> "$GITHUB_STEP_SUMMARY"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
              docker images | grep ephemeral-test-image >> "$GITHUB_STEP_SUMMARY" || echo "No matching images" >> "$GITHUB_STEP_SUMMARY"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
            else
              echo "âŒ Docker image build failed!"
              exit 1
            fi
            
            # Store artifact info for next run verification
            echo "TEST_FILE=$TEST_FILE" >> $GITHUB_ENV
            echo "TEST_IMAGE=$TEST_IMAGE" >> $GITHUB_ENV
            
            echo ""
            echo "### âœ… Artifacts Created Successfully"
            echo ""
            echo "**These artifacts will be checked in the NEXT run to verify they are gone (proving ephemeral behavior)**"
          } >> "$GITHUB_STEP_SUMMARY"
