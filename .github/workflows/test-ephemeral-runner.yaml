name: ðŸ§ª test invoke ephemeral runner
on:
  push: 
    branches: [test-ephemeral-runner]

jobs:
  show-runner-info:
    runs-on: 
      labels: ["self-hosted", "linux", "ARM64", "langflow-ai-arm64-40gb-ephemeral"]
    permissions:
      actions: read
      contents: read
    steps:

      - name: Print runner labels from context
        run: | 
      
      - name: Get runner labels from API 
        run: |
          RUNNER_NAME="${{ runner.name }}" 
          ORG="${{ github.repository_owner }}"
          REPO="${{ github.repository }}"
          
          echo "### Runner Labels from API" >> "$GITHUB_STEP_SUMMARY"
          echo "Looking for runner: **$RUNNER_NAME**" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          
          # Try organization-level API first
          echo "Checking organization runners..." >> "$GITHUB_STEP_SUMMARY"
          ORG_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/orgs/$ORG/actions/runners")
          
          ORG_RUNNER=$(echo "$ORG_RESPONSE" | jq -r ".runners[]? | select(.name == \"$RUNNER_NAME\")")
          
          if [ -n "$ORG_RUNNER" ] && [ "$ORG_RUNNER" != "null" ]; then
            ORG_LABELS=$(echo "$ORG_RUNNER" | jq -r ".labels[]?.name // empty" | tr '\n' ' ')
            echo "âœ… Found in organization runners" >> "$GITHUB_STEP_SUMMARY"
            echo "**Labels:** $ORG_LABELS" >> "$GITHUB_STEP_SUMMARY" 
          else
            echo "âŒ Not found in organization runners" >> "$GITHUB_STEP_SUMMARY" 
            
            # Try repository-level API
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Checking repository runners..." >> "$GITHUB_STEP_SUMMARY"
            REPO_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/$REPO/actions/runners")
            
            REPO_RUNNER=$(echo "$REPO_RESPONSE" | jq -r ".runners[]? | select(.name == \"$RUNNER_NAME\")")
            
            if [ -n "$REPO_RUNNER" ] && [ "$REPO_RUNNER" != "null" ]; then
              REPO_LABELS=$(echo "$REPO_RUNNER" | jq -r ".labels[]?.name // empty" | tr '\n' ' ')
              echo "âœ… Found in repository runners" >> "$GITHUB_STEP_SUMMARY"
              echo "**Labels:** $REPO_LABELS" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "âŒ Not found in repository runners either" >> "$GITHUB_STEP_SUMMARY"
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "âš ï¸ **Note:** Self-hosted runners should have labels. If labels are missing, check:" >> "$GITHUB_STEP_SUMMARY"
              echo "- Runner registration and configuration" >> "$GITHUB_STEP_SUMMARY"
              echo "- API token permissions (needs `actions:read` scope)" >> "$GITHUB_STEP_SUMMARY"
              echo "- Whether runner is online and visible to the API" >> "$GITHUB_STEP_SUMMARY"
            fi
          fi
          
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Workflow-configured labels:** \`self-hosted, linux, ARM64, langflow-ai-arm64-40gb-ephemeral\`" >> "$GITHUB_STEP_SUMMARY"
          
      - name: Show Runner Info in Summary
        run: |
          {
            echo "## ðŸ–¥ï¸ Self-Hosted Runner Info"
            echo "---------- "
            echo "GITHUB_RUNNER_NAME   : '${{ runner.name }}'"
            echo "GITHUB_RUNNER_OS     : '${{ runner.os }}'"
            echo "ENV RUNNER_NAME      : '$RUNNER_NAME'"            
            echo "----------"
            echo "**Hostname:** $(hostname)"
            echo "**Machine:** $(uname -a)"
            echo "**GitHub Workspace:** $GITHUB_WORKSPACE"
            echo "**Runner Temp Dir:** $RUNNER_TEMP"
            echo "**Runner Tool Cache:** $RUNNER_TOOL_CACHE"
            echo ""
            echo "### Environment Variables"
            echo '```'
            printenv | sort
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"
