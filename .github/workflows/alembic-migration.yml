name: Alembic Migration - Deploy

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Select a Branch to deploy"
        required: true
        default: "main"
      environment:
        description: "Select environment to deploy (staging or prod)"
        required: true
        default: "staging"
      email:
        description: "Admin email for deployment"
        required: true
        default: "saravana.k.r@gmail.com"
      commit_id:
        description: "Commit ID to deploy (leave blank for latest on branch)"
        required: false
        default: ""

env:
  STAGING_HOST: staging.visualaiagentsbuilder.com
  PROD_HOST: visualaiagentsbuilder.com

jobs:
  check-db-changes:
    runs-on: ubuntu-latest
    outputs:
      db_changes: ${{ steps.compare.outputs.db_changes }}

    steps:
      - name: Checkout selected branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install \
            alembic SQLAlchemy psycopg2-binary \
            fastapi pydantic google-generativeai python-dotenv

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass    

      - name: Get repo alembic version
        id: repo_version
        run: python .github/script/detect_alembic_revision.py

      - name: Copy check_db_changes.py to VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ github.event.inputs.environment == 'staging' && env.STAGING_HOST || env.PROD_HOST }}
          username: root
          password: ${{ github.event.inputs.environment == 'staging' && secrets.VM_PASSWORD || secrets.PROD_VM_PASSWORD }}
          source: ".github/script/check_db_changes.py"
          target: "/root/workspace/"

      - name: Get VM alembic version
        id: vm_version
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ github.event.inputs.environment == 'staging' && env.STAGING_HOST || env.PROD_HOST }}
          username: root
          password: ${{ github.event.inputs.environment == 'staging' && secrets.VM_PASSWORD || secrets.PROD_VM_PASSWORD }}
        script: python /root/workspace/check_db_changes.py    

      - name: Compare alembic versions
        id: compare
        run: |
          echo "Repo Revision: ${{ steps.repo_version.outputs.repo_alembic_version }}"
          echo "VM Revision:   ${{ steps.vm_version.outputs.vm_alembic_version }}"

          if [ "${{ steps.repo_version.outputs.repo_alembic_version }}" != "${{ steps.vm_version.outputs.vm_alembic_version }}" ]; then
            echo "Alembic versions differ — database upgrade needed."
            echo "db_changes=true" >> $GITHUB_OUTPUT
          else
            echo "Alembic versions match — OK."
            echo "db_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate SQL Migration Files
        run: |
          echo "Generating SQL files..."
          cd src/backend/base/langflow
          mkdir -p alembic_sql
          alembic upgrade head --sql > alembic_sql/upgrade.sql
          alembic downgrade -1 --sql > alembic_sql/downgrade.sql

      - name: Upload SQL files
        uses: actions/upload-artifact@v3
        with:
          name: alembic-sql
          path: src/backend/base/langflow/alembic_sql/

      - name: Install Bytebase CLI
        if: steps.compare.outputs.db_changes == 'true'
        run: |
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/bytebase/install/HEAD/install.sh)"
          sudo mv bb /usr/local/bin

      - name: Verify with Bytebase
        if: steps.compare.outputs.db_changes == 'true'
        run: |
          bb check-sql --file src/backend/base/langflow/alembic_sql/upgrade.sql
          bb check-sql --file src/backend/base/langflow/alembic_sql/downgrade.sql

      - name: Verify with Gemini AI
        if: steps.compare.outputs.db_changes == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python .github/script/verify_sql_with_gemini.py src/backend/base/langflow/alembic_sql/upgrade.sql src/backend/base/langflow/alembic_sql/downgrade.sql

      - name: Manual approval for DB changes
        if: steps.compare.outputs.db_changes == 'true'
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          approvers: ${{ github.actor }}
          minimum-approvals: 1

      - name: Upload SQL artifacts (final bundle)
        if: steps.compare.outputs.db_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: sql-migrations
          path: |
            src/backend/base/langflow/alembic_sql/upgrade.sql
            src/backend/base/langflow/alembic_sql/downgrade.sql